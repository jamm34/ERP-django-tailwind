{% extends 'core/base.html' %}

{% load static %}

{% block title %}Bulk Create Supplier {% endblock %}

{% block content %}
 <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 border-gray-400 pb-2">Suppliers</h2>
 <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-md mt-10">

{% if messages %}
{% for message in messages %}
<div class="p-4 mb-4 rounded-lg
{% if message.tags == 'success' %}bg-green-100 border-l-4 border-green-500 text-green-700{% endif %}
{% if message.tags == 'error' %}bg-red-100 border-l-4 border-red-500 text-red-700{% endif %}" role="alert">
{{ message }}
</div>
{% endfor %}
{% endif %}

{% if not report_generated %}
<h3 class="text-2xl font-semibold text-gray-700 mb-4">Step 1: Upload CSV File</h3>
<p class="text-sm text-gray-500 mb-6">The CSV file must contain a header row that matches the exact field names.> </p>

<div class="flex justify-end mb-4">
<a href="{% url 'suppliers:download_template_suppliers' %}" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300 hover:bg-blue-600 flex items-center space-x-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">

    </svg>
    <span>Download Template</span>
</a>
</div>
<form method="post" enctype="multipart/form-data" class="space-y-6 border p-6 rounded-lg bg-gray-50">
    {% csrf_token %}
    {% if form.non_field_errors %}
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded" role="alert">
        {{form.non_field_errors}}
    </div>
    {% endif %}
    <div>
        <label for="{{ form.csv_file_id_for_label }}" class="block text-sm font-medium text-gray-700">{{ form.csv_file_label }} </label>
        <div class="mt-1">
            <input type="file" name="{{ form.csv_file.html_name }}" id="{{ form.csv_file.id_for_label }}" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#233b6e] file:text-white hover:bg-[#1a2c56] ">
            <p class="mt-2 text-sm text-gray-500">{{ form.csv_file.help_text }}</p>
            {% if form.csv_file.errors %}
            <div class="bg-red-100 border-l-4 border-red-500 text-red-500 p-2 mt-1 rounded text-sm">
                {{  form.csv_file.errors }}
            </div>
            {% endif %}
        </div>
    </div>
    <div class="flex justify-end space-x-4">
        <a href="{% url 'suppliers:suppliers_list' %}" class="bg-gray-300 text-gray-800 font-semibold py-2 px-6 rounded-lg transition-colors duration-300 hover:bg-gray-400">Cancel</a>
        <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-300 hover:bg-green-700">Upload and Process</button>
    </div>
</form>
{% endif %}

{% if report_generated %}
<h3 class="text-2xl font-semibold text-gray-700 mb-4">Step 2: Result Report</h3>
<div class="space-y-4 mb-8 p-4 border rounded-lg bg-gray-50">
    <p class="text-lg font-medium">Total rows proceced: <span class="font-semibold">{{ total_rows }}</span></p>
    <p class="text-lg font-medium text-gray-600">Succesfully created: <span class="font-semibold">{{ successful_count }}</span></p>
    <p class="text-lg font-medium">Rows with errors: <span class="font-semibold">{{ error_count }}</span></p>    
</div>
{% if error_records %}
<h4 class="text-xl font-semibold text-red-600 mb-4 border-b pb-2">Error Details</h4>
<div class="space-y-4 max-h-96 overflow-y-auto">
     {% for record in error_records %}
     <div class="bg-green-50 p-4 border border-red-300 rounded-lg">
        <p class="font-bold text-red-800">Row # {{ record.row }} - {{ record.data.name|default:'[Name not available]' }} (ID: {{ record.data.id_supplier|default:'[N/A]' }})</p>
        <ul class="list-disc list-inside ml-4 text-sm text-red-700 mt-2">
            {% for field, error_msg in record.errors.items %}
            <li><strong>{{ field|capfirst }}:</strong> {{ error_msg }}</li>

    {% endfor %}
        </ul>
     </div>
     {%endfor%}
{% endif %}

</div>
{% endif %}

{% if successful_records %}
<h4 class="text-xl font-semibold text-gray-600 mt-8 mb-4 border-b pb-2">Created Record Detail</h4>
<div class="max-h-64 overflow-y-auto border p-2 rounded bg-green-50">
    {% for record in successful_records %}
    <div class="p-2 border-b border-green-300 text-sm">
        Row #{{record.row}}: **{{record.data.name|default:'[No name]'}}** (ID: {{ record.data.id_supplier|default:'[N/A]' }})
    </div>
    {%endfor%}
</div>
{%endif%}
<div class="flex justify-end mt-8">
    <a href="{% url 'suppliers:suppliers_list' %}" class="bg-[#233b6e] text-white font-semibold py-2 px-6 rounded-lg transition-colors duration-300 hover:bg-[#1a2c53]">Back to list</a>
</div>

</div>
{% endblock %}